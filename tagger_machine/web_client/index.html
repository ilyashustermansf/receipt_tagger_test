<!DOCTYPE html>
<html>
<head>
  <title>Message Classifier</title>
  <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1,minimal-ui" name="viewport">
    <link rel="stylesheet" href="static_files/vue_default.css">
<link rel="stylesheet" href="static_files/bootstrap.css" >
<link rel="stylesheet" href="static_files/gadget_style.css" >
        <script src="static_files/vue.js"></script>
    <script src="static_files/vue_material.min.js"></script>
    <script src="static_files/axios.min.js"></script>
</head>
<body>
<div>
<div class="text-center">

    <div id="message_content">
        <h1>{{title}}</h1>

            <div v-if="loading" class="sk-cube-grid">
              <div class="sk-cube sk-cube1"></div>
              <div class="sk-cube sk-cube2"></div>
              <div class="sk-cube sk-cube3"></div>
              <div class="sk-cube sk-cube4"></div>
              <div class="sk-cube sk-cube5"></div>
              <div class="sk-cube sk-cube6"></div>
              <div class="sk-cube sk-cube7"></div>
              <div class="sk-cube sk-cube8"></div>
              <div class="sk-cube sk-cube9"></div>
            </div>
            <iframe v-else="loading" id="iframe_message" :onload="iframeLoaded" :src="messageDomain" ></iframe>

    </div>

   <div id="app">
        <span>
       <md-button v-on:click="sendAnswerYes" class="btn btn-success btn-lg">Yes</md-button>
       <md-button v-on:click="sendAnswerNo" class="btn btn-danger btn-lg">No</md-button>
       <md-button v-on:click="sendAnswerSkip" class="btn btn-secondary btn-lg">Skip</md-button>
        </span>
    </div>

</div>
    </div>
    <script>


      function getMessageUrl(messageId) {
          return 'messages/'+messageId+'.html';
      }
      function incrementMessageCount(count){
          count +=1;
          localStorage.setItem('countMessage', count);
      }

      Vue.use(VueMaterial.default);
        var message_element_view = new Vue({
            el: '#message_content',
            data: {
                loading: false,
                title: 'Is this Message Receipt?',
                messageDomain: '',
                messageId: null
            },
            mounted: function(){
                this.iframeLoaded();
                this.initiateMessages();
            },
            methods: {
                iframeLoaded: function () {
                  var iFrameID = document.getElementById('iframe_message');
                  if(iFrameID) {
                      iFrameID.height = "";
                      iFrameID.width = "";
                      var width = 1000;
                      var height = 700;
                      if (iFrameID.contentWindow.document.body != null){
                            var scrollWidth = iFrameID.contentWindow.document.body.scrollWidth;
                            var scrollHeight = iFrameID.contentWindow.document.body.scrollHeight;
                            if(scrollWidth> width){
                                width = scrollWidth;
                            }
                            if (scrollHeight> height){
                                height = scrollHeight;
                            }
                      }
                      iFrameID.height = height + "px";
                      iFrameID.width = width + "px";
                  }
                },
                initiateMessages: function(){
                    var self = this;
                    console.log('Initiated!');
                    localStorage.removeItem('messages');
                    localStorage.removeItem('countMessage');
                    self.loading = true;
                    axios.get('/get_messages')
                      .then(function (response) {
                          self.insertTagsIfExist();
                        localStorage.setItem('messages', JSON.stringify(response.data));
                        localStorage.setItem('tags', JSON.stringify([]));
                        localStorage.setItem('countMessage', 0);
                        console.log('Got messages!');
                        self.loading = false;
                      })
                      .catch(function (error) {
                        console.log(error);
                      });
                },
                getNextMessage: function (){
                    var count = parseInt(localStorage.getItem('countMessage'));
                    var messages = JSON.parse(localStorage.getItem('messages'));

                    console.log('count='+count);
                    console.log('messages='+messages);
                    console.log('length='+messages.length);
                    if(count === messages.length){
                        this.initiateMessages();
                        count = 0;
                    }
                    this.messageId = messages[count]['id'];
                    var url = getMessageUrl(this.messageId);
                    incrementMessageCount(count);
                    this.iframeLoaded();
                    return url
                },
                insertTagsIfExist: function () {
                    var tags = JSON.parse(localStorage.getItem('tags'));
                    if (tags !== null && tags.length > 0){
                        axios.post('/add_tags', tags)
                          .then(function (response) {
                            // console.log(response);
                            console.log(response.status+' OK! got tags='+tags);
                          })
                          .catch(function (error) {
                            console.log(error);
                          });
                    }
                }
            }
        });

    var app = new Vue({
        el: '#app',
                    methods: {
                        sendAnswerYes: function () {
                            // TODO send answer message_id + yes/no
                            // TODO load next message get next iframe to display
                            console.log("answered yes");
                            this.handelingNextMessage(this.prepareTag(true,
                                message_element_view.messageId));
                        },
                        sendAnswerNo: function () {
                            console.log("answered no");
                            this.handelingNextMessage(this.prepareTag(false,
                                message_element_view.messageId));
                        },
                        sendAnswerSkip: function (){
                            console.log("answered skip");
                            this.handelingNextMessage(null);
                        },
                        handelingNextMessage: function (answer){
                            if(answer === null || answer['message_id'] === null){
                                console.log('skip..')
                            }
                            else{
                                this.insertTag(answer);
                            }
                            console.log("loading next message..."+answer);
                            message_element_view.messageDomain = message_element_view.getNextMessage();
                        },
                        prepareTag: function (answer, messageId) {
                            return {'message_id': messageId,
                                'is_receipt': answer}
                        },
                        insertTag: function(answer) {
                            var tags = JSON.parse(localStorage.getItem('tags'));
                            tags.push(answer);
                            localStorage.setItem('tags', JSON.stringify(tags));
                        }
                    }
      });
    </script>
</body>
</html>